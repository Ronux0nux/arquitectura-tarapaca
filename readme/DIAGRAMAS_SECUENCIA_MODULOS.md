# ๐ DIAGRAMAS DE SECUENCIA - Mรณdulos Principales

**Fecha:** 20 de Octubre, 2025  
**Proyecto:** Arquitectura Tarapacรก  
**Versiรณn:** 1.0  
**Tipo:** Diagramas de Secuencia (UML)

---

## ๐ รNDICE

1. [Mรณdulo de Proveedores](#1-mรณdulo-de-proveedores---diagrama-de-secuencia)
2. [Mรณdulo de Proyectos](#2-mรณdulo-de-proyectos---diagrama-de-secuencia)
3. [Mรณdulo de Bรบsqueda de Materiales](#3-mรณdulo-de-bรบsqueda-de-materiales-serpapi---diagrama-de-secuencia)
4. [Mรณdulo de Presupuestos/Cotizaciones](#4-mรณdulo-de-presupuestoscotizaciones---diagrama-de-secuencia)
5. [Mรณdulo Excel Online](#5-mรณdulo-excel-online---diagrama-de-secuencia)

---

# 1. MรDULO DE PROVEEDORES - DIAGRAMA DE SECUENCIA

## ๐ LISTAR PROVEEDORES

```
โโโโโโโโโโ                                                    
โUsuario โ                                                    
โโโโโฌโโโโโ                                                    
    โ                                                         
    โ 1. GET /api/providers                                   
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                      โโโโโโโโโโโโโ
    โ                                                      โ  Frontend โ
    โ                                                      โ  (React)  โ
    โ                                                      โโโโโโโฌโโโโโโ
    โ                                                            โ
    โ                                                            โ 2. HTTP Request
    โ                                                            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                โโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                โ  Express Server โ
    โ                                                            โ                                โโโโโโโโโโฌโโโโโโโโโ
    โ                                                            โ                                         โ
    โ                                                            โ                                         โ 3. router.get('/')
    โ                                                            โ                                         โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                         โ          โโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                         โ          โ providerRouter โ
    โ                                                            โ                                         โ          โโโโโโโโโโฌโโโโโโโโ
    โ                                                            โ                                         โ                   โ
    โ                                                            โ                                         โ                   โ 4. getProviders()
    โ                                                            โ                                         โ                   โโโโโโโโโโโโโโโ>
    โ                                                            โ                                         โ                   โ  โโโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                         โ                   โ  โ providerController โ
    โ                                                            โ                                         โ                   โ  โโโโโโโโโโฌโโโโโโโโโโโโ
    โ                                                            โ                                         โ                   โ           โ
    โ                                                            โ                                         โ                   โ           โ 5. Provider.findAll()
    โ                                                            โ                                         โ                   โ           โโโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                         โ                   โ           โ     โโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                         โ                   โ           โ     โ   PostgreSQL     โ
    โ                                                            โ                                         โ                   โ           โ     โ  SELECT * FROM  โ
    โ                                                            โ                                         โ                   โ           โ     โ  providers      โ
    โ                                                            โ                                         โ                   โ           โ     โโโโโโโโโโฌโโโโโโโโ
    โ                                                            โ                                         โ                   โ           โ              โ
    โ                                                            โ                                         โ                   โ           โ 6. [providers] โ Datos
    โ                                                            โ                                         โ                   โ           โ<โโโโโโโโโโโโโโ
    โ                                                            โ                                         โ                   โ           โ
    โ                                                            โ                                         โ                   โ           โ 7. res.json(providers)
    โ                                                            โ                                         โ                   โ           โโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                         โ                   โ 8. JSON response
    โ                                                            โ                                         โ                   โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                         โ 9. JSON response
    โ                                                            โ                                         โ<โโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ 10. HTTP Response (200)
    โ                                                            โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 11. Renderizar tabla
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Muestra lista de 25+ proveedores]
```

---

## ๐ CREAR NUEVO PROVEEDOR

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. POST /api/providers
    โ    { nombre, contacto, direcciรณn, telรฉfono, email }
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                      โโโโโโโโโโโโโโ
    โ                                                      โ  Frontend  โ
    โ                                                      โ   (Form)   โ
    โ                                                      โโโโโโโฌโโโโโโโ
    โ                                                            โ
    โ                                                            โ 2. HTTP POST
    โ                                                            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                 โโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                 โ Express Server   โ
    โ                                                            โ                                 โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                            โ                                          โ
    โ                                                            โ                                          โ 3. router.post('/')
    โ                                                            โ                                          โโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                          โ      โโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                          โ      โ providerRouter   โ
    โ                                                            โ                                          โ      โโโโโโโโโโโโฌโโโโโโโโ
    โ                                                            โ                                          โ                 โ
    โ                                                            โ                                          โ                 โ 4. createProvider(req.body)
    โ                                                            โ                                          โ                 โโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                          โ                 โ  โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                          โ                 โ  โ providerController   โ
    โ                                                            โ                                          โ                 โ  โโโโโโโโโโโฌโโโโโโโโโโโโ
    โ                                                            โ                                          โ                 โ            โ
    โ                                                            โ                                          โ                 โ            โ 5. Validar datos
    โ                                                            โ                                          โ                 โ            โโโโโโโโโโโโโโโ>
    โ                                                            โ                                          โ                 โ            โ
    โ                                                            โ                                          โ                 โ            โ 6. Provider.create()
    โ                                                            โ                                          โ                 โ            โโโโโโโโโโโโโโโโโโโ>
    โ                                                            โ                                          โ                 โ            โ    โโโโโโโโโโโโโโโ
    โ                                                            โ                                          โ                 โ            โ    โ PostgreSQL  โ
    โ                                                            โ                                          โ                 โ            โ    โ INSERT INTO โ
    โ                                                            โ                                          โ                 โ            โ    โ providers   โ
    โ                                                            โ                                          โ                 โ            โ    โโโโโโโโฌโโโโโ
    โ                                                            โ                                          โ                 โ            โ           โ
    โ                                                            โ                                          โ                 โ            โ 7. ID generado
    โ                                                            โ                                          โ                 โ            โ<โโโโโโโโโโโ
    โ                                                            โ                                          โ                 โ            โ
    โ                                                            โ                                          โ                 โ 8. res.status(201).json(result)
    โ                                                            โ                                          โ                 โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ                                          โ 9. HTTP 201 Created
    โ                                                            โ                                          โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                            โ 10. HTTP 201
    โ                                                            โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 11. Mostrar confirmaciรณn
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Proveedor creado exitosamente]
```

---

## ๐ OBTENER PROVEEDOR POR ID

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. GET /api/providers/123
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                  โโโโโโโโโโโโโโโ
    โ                                                  โ  Frontend   โ
    โ                                                  โ   (React)   โ
    โ                                                  โโโโโโโโฌโโโโโโโ
    โ                                                         โ
    โ                                                         โ 2. HTTP GET con ID
    โ                                                         โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                         โ              โโโโโโโโโโโโโโโโโโโ
    โ                                                         โ              โ Express Server  โ
    โ                                                         โ              โโโโโโโโโโฌโโโโโโโโโ
    โ                                                         โ                       โ
    โ                                                         โ                       โ 3. getProviderById(123)
    โ                                                         โ                       โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                         โ                       โ โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                         โ                       โ โ providerController   โ
    โ                                                         โ                       โ โโโโโโโโโโโฌโโโโโโโโโโโโโ
    โ                                                         โ                       โ           โ
    โ                                                         โ                       โ           โ 4. Provider.findById(123)
    โ                                                         โ                       โ           โโโโโโโโโโโโโโโโโโโ>
    โ                                                         โ                       โ           โ โโโโโโโโโโโโโโโโ
    โ                                                         โ                       โ           โ โ PostgreSQL   โ
    โ                                                         โ                       โ           โ โ SELECT * ... โ
    โ                                                         โ                       โ           โ โ WHERE id=123 โ
    โ                                                         โ                       โ           โ โโโโโโโโโโฌโโโโโ
    โ                                                         โ                       โ           โ          โ
    โ                                                    ALT  โโโโโโโโโโโโโโโโโโโโโโโโโค          โ 5a. Encontrado
    โ                                                     โ โ โ                       โ          โ<โโโโโโโโโค
    โ                                                    ALT  โ                       โ          โ          โ
    โ                                                         โ                       โ          โ 5b. res.json(provider)
    โ                                                         โ                       โ          โโโโโโโโโโโโโโโโโโโ>
    โ                                                         โ                       โ          โ
    โ                                                         โ                       โ 6. Retorna objeto
    โ                                                         โ                       โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ                                                         โ                       โ
    โ                                                         โ 7. HTTP 200 OK
    โ                                                         โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ 8. HTTP 200
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Muestra detalles del proveedor]
    
    ALT (Si no existe):
    โ 4b. Provider.findById(999) โ null
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 5c. res.status(404).json({ error: 'No encontrado' })
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ [Mostrar error 404]
```

---

# 2. MรDULO DE PROYECTOS - DIAGRAMA DE SECUENCIA

## ๐ CREAR PROYECTO Y OBTENER RESUMEN DE MATERIALES

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. Completa formulario de proyecto
    โ    { nombre, cรณdigo, descripciรณn, fechaInicio, ... }
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                              โโโโโโโโโโโโโโโโ
    โ                                              โ  Frontend    โ
    โ                                              โ (Dashboard)  โ
    โ                                              โโโโโโโฌโโโโโโโโโ
    โ                                                    โ
    โ                                                    โ 2. POST /api/projects
    โ                                                    โโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ              โโโโโโโโโโโโโโโโโโโ
    โ                                                    โ              โ Express Server  โ
    โ                                                    โ              โโโโโโโโโโฌโโโโโโโโโ
    โ                                                    โ                       โ
    โ                                                    โ                       โ 3. createProject(req.body)
    โ                                                    โ                       โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                       โ โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ                       โ โ projectController    โ
    โ                                                    โ                       โ โโโโโโโโโโโฌโโโโโโโโโโโโโ
    โ                                                    โ                       โ           โ
    โ                                                    โ                       โ           โ 4. Project.create()
    โ                                                    โ                       โ           โโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                       โ           โ โโโโโโโโโโโโโโโโ
    โ                                                    โ                       โ           โ โ PostgreSQL   โ
    โ                                                    โ                       โ           โ โ INSERT INTO  โ
    โ                                                    โ                       โ           โ โ projects     โ
    โ                                                    โ                       โ           โ โโโโโโโโโโฌโโโโโ
    โ                                                    โ                       โ           โ          โ
    โ                                                    โ                       โ           โ 5. ID generado
    โ                                                    โ                       โ           โ<โโโโโโโโโโ
    โ                                                    โ                       โ 6. res.json(projectData)
    โ                                                    โ                       โ<โโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ 7. HTTP 201 Created
    โ                                                    โ<โโโโโโโโโโโโโโโโโโโโโโ
    โ 8. Guardado, ahora obtener materiales
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โ 9. GET /api/projects/{id}/materiales
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                              โโโโโโโโโโโโโโโโ
    โ                                              โ  Frontend    โ
    โ                                              โ (Dashboard)  โ
    โ                                              โโโโโโโฌโโโโโโโโโ
    โ                                                    โ
    โ                                                    โ 10. HTTP GET
    โ                                                    โโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                 โโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ                 โ Express Server   โ
    โ                                                    โ                 โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                    โ                          โ
    โ                                                    โ                          โ 11. getProjectMaterialSummary()
    โ                                                    โ                          โโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                          โ โโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ โ projectController       โ
    โ                                                    โ                          โ โโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ
    โ                                                    โ                          โ            โ 12a. Project.findById(id)
    โ                                                    โ                          โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                          โ            โ โโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ โ PostgreSQL    โ
    โ                                                    โ                          โ            โ โ SELECT ...    โ
    โ                                                    โ                          โ            โ โ FROM projects โ
    โ                                                    โ                          โ            โ โโโโโโโโโฌโโโโโโโโ
    โ                                                    โ                          โ            โ         โ
    โ                                                    โ                          โ            โ 13a. Project data
    โ                                                    โ                          โ            โ<โโโโโโโโ
    โ                                                    โ                          โ            โ
    โ                                                    โ                          โ            โ 12b. Cotizacion.find({proyectoId})
    โ                                                    โ                          โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                          โ            โ โโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ โ PostgreSQL            โ
    โ                                                    โ                          โ            โ โ SELECT * FROM         โ
    โ                                                    โ                          โ            โ โ cotizaciones WHERE ... โ
    โ                                                    โ                          โ            โ โโโโโโโโโฌโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ         โ
    โ                                                    โ                          โ            โ 13b. [cotizaciones]
    โ                                                    โ                          โ            โ<โโโโโโโโ
    โ                                                    โ                          โ            โ
    โ                                                    โ                          โ            โ 12c. OrdenCompra.find({proyectoId})
    โ                                                    โ                          โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                          โ            โ โโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ โ PostgreSQL            โ
    โ                                                    โ                          โ            โ โ SELECT * FROM         โ
    โ                                                    โ                          โ            โ โ orden_compra WHERE ... โ
    โ                                                    โ                          โ            โ โโโโโโโโโฌโโโโโโโโโโโโโโโโ
    โ                                                    โ                          โ            โ         โ
    โ                                                    โ                          โ            โ 13c. [ordenes]
    โ                                                    โ                          โ            โ<โโโโโโโโ
    โ                                                    โ                          โ            โ
    โ                                                    โ                          โ            โ 14. Calcular resรบmenes
    โ                                                    โ                          โ            โโโโโโโโโโโโโโ>
    โ                                                    โ                          โ            โ
    โ                                                    โ                          โ            โ 15. res.json({proyecto, cotizaciones, ordenes})
    โ                                                    โ                          โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                    โ                          โ 16. Respuesta completa
    โ                                                    โ                          โ<โโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                    โ 17. HTTP 200 OK
    โ                                                    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 18. Renderizar dashboard
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Muestra: Proyecto + Cotizaciones + รrdenes + Materiales]
```

---

# 3. MรDULO DE BรSQUEDA DE MATERIALES (SERPAPI) - DIAGRAMA DE SECUENCIA

## ๐ BUSCAR MATERIALES Y GUARDAR RESULTADOS

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. Ingresa "cemento" en buscador
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโ
    โ                                            โ  Frontend   โ
    โ                                            โ (Buscador)  โ
    โ                                            โโโโโโโโฌโโโโโโโ
    โ                                                   โ
    โ                                                   โ 2. GET /api/search/materials?term=cemento
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                         โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                         โ Express Server   โ
    โ                                                   โ                         โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                                  โ
    โ                                                   โ                                  โ 3. Llamar SERPAPI
    โ                                                   โ                                  โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                                  โ          โโโโโโโโโโโโโโโโ
    โ                                                   โ                                  โ          โ   SERPAPI    โ
    โ                                                   โ                                  โ          โ  Google Shop โ
    โ                                                   โ                                  โ          โโโโโโโโโโฌโโโโโโ
    โ                                                   โ                                  โ                   โ
    โ                                                   โ                                  โ 4. Buscar "cemento"
    โ                                                   โ                                  โโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                                  โ                   โ
    โ                                                   โ                                  โ 5. Retorna 15 resultados:
    โ                                                   โ                                  โ [{ title, price, link,
    โ                                                   โ                                  โ product_link, rating,
    โ                                                   โ                                  โ reviews, ... }]
    โ                                                   โ                                  โ<โโโโโโโโโโโโโโโโโโ
    โ                                                   โ                                  โ
    โ                                                   โ 6. POST /api/dataset/saveSearchResults
    โ                                                   โ    { searchTerm: "cemento", results: [...] }
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                         โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                         โ Express Server   โ
    โ                                                   โ                         โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                                  โ
    โ                                                   โ                                  โ 7. datasetController.saveSearchResults()
    โ                                                   โ                                  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                                  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                                  โ โ datasetController         โ
    โ                                                   โ                                  โ โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
    โ                                                   โ                                  โ            โ
    โ                                                   โ LOOP: Para cada resultado        โ            โ
    โ                                                   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโค
    โ                                                   โ โ 8. Insumo.findOne({nombre})    โ            โ
    โ                                                   โ โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ>
    โ                                                   โ โ    โ โโโโโโโโโโโโโโโโโโโโ      โ            โ
    โ                                                   โ โ    โ โ PostgreSQL       โ      โ            โ
    โ                                                   โ โ    โ โ SELECT * WHERE   โ      โ            โ
    โ                                                   โ โ    โ โ nombre = ...     โ      โ            โ
    โ                                                   โ โ    โ โโโโโโโโโโฌโโโโโโโโโโ      โ            โ
    โ                                                   โ โ    โ          โ                โ            โ
    โ                                                   โ โ    โ 9. ALT: No existe        โ            โ
    โ                                                   โ โ    โ    Insumo.create({       โ            โ
    โ                                                   โ โ    โ      nombre: "Cemento",  โ            โ
    โ                                                   โ โ    โ      metadata: {         โ            โ
    โ                                                   โ โ    โ        link: "https://", โ            โ
    โ                                                   โ โ    โ        price: 8500,      โ            โ
    โ                                                   โ โ    โ        rating: 4.5,      โ โ LINKS   โ
    โ                                                   โ โ    โ        reviews: 250,     โ Guardados! โ
    โ                                                   โ โ    โ        origenBusqueda... โ            โ
    โ                                                   โ โ    โ      }                   โ            โ
    โ                                                   โ โ    โ    })                    โ            โ
    โ                                                   โ โ    โ    โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ>
    โ                                                   โ โ    โ    โ โโโโโโโโโโโโโโโโโโโโ โ            โ
    โ                                                   โ โ    โ    โ โ PostgreSQL       โ โ            โ
    โ                                                   โ โ    โ    โ โ INSERT INTO      โ โ            โ
    โ                                                   โ โ    โ    โ โ insumos (+ JSON) โ โ            โ
    โ                                                   โ โ    โ    โ โโโโโโโโโโฌโโโโโโโโโโ โ            โ
    โ                                                   โ โ    โ    โ          โ           โ            โ
    โ                                                   โ โ    โ    โ 10a. ID generado    โ            โ
    โ                                                   โ โ    โ    โ<โโโโโโโโโโโโโโโโโโโโโโผโ          โ
    โ                                                   โ โ    โ    โ                      โ            โ
    โ                                                   โ โ    โ ALT: Ya existe             โ            โ
    โ                                                   โ โ    โ 10b. Actualizar metadata   โ            โ
    โ                                                   โ โ    โ      (link, rating,       โ            โ
    โ                                                   โ โ    โ       reviews, ...)       โ            โ
    โ                                                   โ โ    โ      UPDATE insumos ...   โ            โ
    โ                                                   โ โ    โ      โโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโ>
    โ                                                   โ โ    โ      โ โโโโโโโโโโโโโโโโโโโโ โ            โ
    โ                                                   โ โ    โ      โ โ PostgreSQL       โ โ            โ
    โ                                                   โ โ    โ      โ โ UPDATE ...       โ โ            โ
    โ                                                   โ โ    โ      โ โ SET metadata ... โ โ            โ
    โ                                                   โ โ    โ      โ โโโโโโโโโโฌโโโโโโโโโโ โ            โ
    โ                                                   โ โ    โ      โ          โ           โ            โ
    โ                                                   โ โ    โ      โ Actualizado        โ            โ
    โ                                                   โ โ    โ      โ<โโโโโโโโโโโโโโโโโโโโโโผโ          โ
    โ                                                   โ โ    โ                            โ            โ
    โ                                                   โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโค
    โ                                                   โ       (Fin del LOOP)            โ            โ
    โ                                                   โ                                  โ            โ
    โ                                                   โ 11. res.json({                  โ            โ
    โ                                                   โ     message: "Procesados",      โ            โ
    โ                                                   โ     savedCount: 14,             โ            โ
    โ                                                   โ     totalResults: 15            โ            โ
    โ                                                   โ     })                          โ            โ
    โ                                                   โ 12. HTTP 200 OK                 โ            โ
    โ                                                   โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโโโโโโโโโโโโโค
    โ 13. Mostrar resultados en tabla
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Muestra 15 materiales con links, precios y calificaciones]
       [Todos guardados en BD para futuras bรบsquedas]
```

---

# 4. MรDULO DE PRESUPUESTOS/COTIZACIONES - DIAGRAMA DE SECUENCIA

## ๐ CREAR COTIZACIรN Y OBTENER RESUMEN POR PROYECTO

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. Selecciona proyecto y material
    โ    Ingresa cantidad y selecciona proveedor
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโโโโโโ
    โ                                            โ  Frontend        โ
    โ                                            โ (Presupuestos)   โ
    โ                                            โโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ
    โ                                                   โ 2. POST /api/cotizaciones
    โ                                                   โ    { proyectoId, proveedorId, 
    โ                                                   โ      cantidad, precioUnitario, ... }
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                    โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                    โ Express Server   โ
    โ                                                   โ                    โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                            โ
    โ                                                   โ                            โ 3. createCotizacion()
    โ                                                   โ                            โโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ โ cotizacionController โ
    โ                                                   โ                            โ โโโโโโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ                            โ           โ
    โ                                                   โ                            โ           โ 4. Cotizacion.create()
    โ                                                   โ                            โ           โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ           โ โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ           โ โ PostgreSQL       โ
    โ                                                   โ                            โ           โ โ INSERT INTO      โ
    โ                                                   โ                            โ           โ โ cotizaciones     โ
    โ                                                   โ                            โ           โ โ estado: Pendienteโ
    โ                                                   โ                            โ           โ โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                            โ           โ          โ
    โ                                                   โ                            โ           โ 5. ID generado
    โ                                                   โ                            โ           โ<โโโโโโโโโโ
    โ                                                   โ                            โ 6. res.json(cotizacionData)
    โ                                                   โ                            โ<โโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ 7. HTTP 201 Created
    โ                                                   โ<โโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 8. Cotizaciรณn creada, obtener resumen
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โ 9. GET /api/cotizaciones/proyecto/123
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโโโโโโ
    โ                                            โ  Frontend        โ
    โ                                            โ (Dashboard)      โ
    โ                                            โโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ
    โ                                                   โ 10. HTTP GET
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                 โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                 โ Express Server   โ
    โ                                                   โ                 โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                          โ
    โ                                                   โ                          โ 11. getCotizacionesByProject(123)
    โ                                                   โ                          โโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                          โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                          โ โ cotizacionController     โ
    โ                                                   โ                          โ โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
    โ                                                   โ                          โ            โ
    โ                                                   โ                          โ            โ 12. Cotizacion.findAll()
    โ                                                   โ                          โ            โ      .filter(c => c.proyectoId == 123)
    โ                                                   โ                          โ            โโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                          โ            โ โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                          โ            โ โ PostgreSQL       โ
    โ                                                   โ                          โ            โ โ SELECT * FROM    โ
    โ                                                   โ                          โ            โ โ cotizaciones     โ
    โ                                                   โ                          โ            โ โ WHERE proyectoId โ
    โ                                                   โ                          โ            โ โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                          โ            โ          โ
    โ                                                   โ                          โ            โ 13. [6 cotizaciones]
    โ                                                   โ                          โ            โ<โโโโโโโโโโ
    โ                                                   โ                          โ            โ
    โ                                                   โ                          โ            โ 14. Calcular RESUMEN:
    โ                                                   โ                          โ            โโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                          โ            โ โข total: 6
    โ                                                   โ                          โ            โ โข pendientes: 3
    โ                                                   โ                          โ            โ โข aprobadas: 2
    โ                                                   โ                          โ            โ โข compradas: 1
    โ                                                   โ                          โ            โ โข montoTotal: $145,600
    โ                                                   โ                          โ            โ
    โ                                                   โ                          โ 15. res.json({
    โ                                                   โ                          โ     cotizaciones: [...],
    โ                                                   โ                          โ     resumen: {...}
    โ                                                   โ                          โ     })
    โ                                                   โ                          โ<โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ 16. HTTP 200 OK
    โ                                                   โ<โโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ 17. Renderizar tabla + resumen
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Muestra: 6 cotizaciones + Estadรญsticas]
       [Pendientes: 3 | Aprobadas: 2 | Compradas: 1]
       [Monto Total: $145,600]
```

---

# 5. MรDULO EXCEL ONLINE - DIAGRAMA DE SECUENCIA

## ๐ GENERAR PLANTILLA EXCEL Y AGREGAR DATOS

```
โโโโโโโโโโ
โUsuario โ
โโโโโฌโโโโโ
    โ
    โ 1. Click en "Generar Excel"
    โ    Selecciona tipo: PRESUPUESTO
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโโโโโโ
    โ                                            โ  Frontend        โ
    โ                                            โ (Excel Viewer)   โ
    โ                                            โโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ
    โ                                                   โ 2. GET /api/excel/template?projectId=123
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                    โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                    โ Express Server   โ
    โ                                                   โ                    โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                            โ
    โ                                                   โ                            โ 3. getExcelTemplate()
    โ                                                   โ                            โโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ โโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ โ excelController       โ
    โ                                                   โ                            โ โ (En Memoria - No BD)  โ
    โ                                                   โ                            โ โโโโโโโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 4a. createPresupuestoTemplate()
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ โโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ โ Retorna Array 2D:    โ
    โ                                                   โ                            โ            โ โ [                    โ
    โ                                                   โ                            โ            โ โ   ['ITEM','DESC',...]
    โ                                                   โ                            โ            โ โ   ['1','Cemento',...] 
    โ                                                   โ                            โ            โ โ ]                    โ
    โ                                                   โ                            โ            โ โโโโโโโโโโโโฌโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ            โ
    โ                                                   โ                            โ            โ 4b. createAPUTemplate()
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 4c. createRecursosTemplate()
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 5. Retornar JSON:
    โ                                                   โ                            โ            โ    {
    โ                                                   โ                            โ            โ      sheets: {...},
    โ                                                   โ                            โ            โ      sheetNames: [...],
    โ                                                   โ                            โ            โ      projectId: 123,
    โ                                                   โ                            โ            โ      metadata: {...}
    โ                                                   โ                            โ            โ    }
    โ                                                   โ 6. HTTP 200 OK con JSON     โ            โ
    โ                                                   โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโโโโโโโโโโโโค
    โ 7. Frontend recibe y renderiza Excel en tabla
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ    [Muestra headers + fila de ejemplo + totales]
    โ
    โ 8. Usuario selecciona materiales del dataset
    โ    Click en "Agregar a Excel"
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโโโโโโ
    โ                                            โ  Frontend        โ
    โ                                            โ (Excel Editor)   โ
    โ                                            โโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ
    โ                                                   โ 9. POST /api/excel/addDataset
    โ                                                   โ    {
    โ                                                   โ      sheetName: "PRESUPUESTO",
    โ                                                   โ      products: [
    โ                                                   โ        {nombre: "Cemento", 
    โ                                                   โ         cantidad: 10,
    โ                                                   โ         precio: 8500, ...}
    โ                                                   โ      ],
    โ                                                   โ      format: "presupuesto",
    โ                                                   โ      projectId: 123
    โ                                                   โ    }
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                    โโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                    โ Express Server   โ
    โ                                                   โ                    โโโโโโโโโโฌโโโโโโโโโโ
    โ                                                   โ                            โ
    โ                                                   โ                            โ 10. addDatasetToExcel()
    โ                                                   โ                            โโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ โโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ โ excelController       โ
    โ                                                   โ                            โ โโโโโโโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 11. getCurrentSheetData("PRESUPUESTO")
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 12. formatProductsForExcel(products, format)
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ โ Retorna filas formateadas โ
    โ                                                   โ                            โ            โ โ con fรณrmulas SUM()       โ
    โ                                                   โ                            โ            โ โ [                        โ
    โ                                                   โ                            โ            โ โ   [1, "Cemento", ..., ... โ
    โ                                                   โ                            โ            โ โ   [2, "Arena", ..., ...   โ
    โ                                                   โ                            โ            โ โ ]                        โ
    โ                                                   โ                            โ            โ โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
    โ                                                   โ                            โ            โ            โ
    โ                                                   โ                            โ            โ 13. Insertar en currentData
    โ                                                   โ                            โ            โโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ                            โ            โ
    โ                                                   โ                            โ            โ 14. Retornar datos actualizados
    โ                                                   โ                            โ            โ      {
    โ                                                   โ                            โ            โ        success: true,
    โ                                                   โ                            โ            โ        rowsAdded: 2,
    โ                                                   โ                            โ            โ        data: [...nuevos datos...]
    โ                                                   โ                            โ            โ      }
    โ                                                   โ 15. HTTP 200 OK             โ            โ
    โ                                                   โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโคโโโโโโโโโโโโค
    โ 16. Frontend actualiza tabla Excel
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ    [Muestra 2 nuevas filas con datos + totales recalculados]
    โ
    โ 17. Usuario descarga Excel
    โ    Click en "Descargar .xlsx"
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                            โโโโโโโโโโโโโโโโโโโโ
    โ                                            โ  Frontend        โ
    โ                                            โ (XLSX.js)        โ
    โ                                            โโโโโโโฌโโโโโโโโโโโโโ
    โ                                                   โ
    โ                                                   โ 18. XLSX.utils.book_new()
    โ                                                   โ     XLSX.utils.aoa_to_sheet(data)
    โ                                                   โ     XLSX.writeFile(workbook)
    โ                                                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ>
    โ                                                   โ 19. Descarga archivo local
    โ                                                   โ     "presupuesto_proyecto_123.xlsx"
    โ 20. Archivo descargado โ
    โ<โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
    โโ [Usuario tiene Excel profesional en su PC]
       [Con datos reales + fรณrmulas de cรกlculo]
       [Editablะต offline]
```

---

## ๐ RESUMEN DE INTERACCIONES

### Secuencia General de Mรณdulos

```
Usuario
  โ
  โโโ 1. PROVEEDORES
  โ      GET /api/providers โ Listar
  โ      POST /api/providers โ Crear
  โ      GET /api/providers/:id โ Detalles
  โ      [Datos en PostgreSQL]
  โ
  โโโ 2. PROYECTOS
  โ      POST /api/projects โ Crear proyecto
  โ      GET /api/projects/:id โ Detalles
  โ      GET /api/projects/:id/materiales โ Resumen
  โ      [Integra con Cotizaciones + รrdenes]
  โ
  โโโ 3. BรSQUEDA MATERIALES
  โ      GET /api/search/materials โ SERPAPI
  โ      POST /api/dataset/saveSearchResults โ Guardar
  โ      [Links + Precios en PostgreSQL]
  โ
  โโโ 4. PRESUPUESTOS
  โ      POST /api/cotizaciones โ Crear
  โ      GET /api/cotizaciones/proyecto/:id โ Resumen
  โ      [Estados: Pendiente โ Aprobada โ Comprada]
  โ
  โโโ 5. EXCEL
         GET /api/excel/template โ Crear plantilla
         POST /api/excel/addDataset โ Agregar datos
         [Descarga en cliente - Sin guardar]
```

---

## ๐ Flujo Completo de Negocio

```
1. INICIO
   Usuario โ Selecciona/Crea Proyecto
                    โ
2. BรSQUEDA
   Usuario โ Busca Materiales (SERPAPI)
         โ
   Sistema โ Extrae Links + Precios
         โ
   Guarda en insumos (BD)
                    โ
3. PRESUPUESTO
   Usuario โ Agrega Materiales
         โ
   Sistema โ Crea Cotizaciones
         โ
   Calcula Totales
                    โ
4. EXPORTACIรN
   Usuario โ Genera Excel
         โ
   Sistema โ Crea Plantilla en Memoria
         โ
   Agrega Datos + Fรณrmulas
         โ
   Usuario โ Descarga .xlsx
                    โ
5. FIN
   Documento listo para compartir/imprimir
```

---

## ๐ Tabla de Actores y Sistemas

| Actor/Sistema | Rol | Acciรณn |
|---|---|---|
| **Usuario** | Iniciador | Ingresa datos, solicita bรบsquedas |
| **Frontend (React)** | Cliente | Renderiza UI, envรญa requests HTTP |
| **Express Server** | Orquestador | Recibe requests, valida, delega |
| **Controllers** | Lรณgica | Procesa datos, llama a modelos |
| **Models** | Acceso a datos | Queries a BD |
| **PostgreSQL** | Persistencia | Almacena datos |
| **SERPAPI** | Externa | Busca en Google Shopping |
| **Redis** | Cachรฉ | (Opcional para searches) |
| **XLSX.js** | Generaciรณn | Crea Excel en cliente |

---

## โจ Conclusiรณn

Estos diagramas de secuencia muestran:

โ **Flujo temporal completo** de cada operaciรณn  
โ **Interacciรณn entre componentes** en el tiempo  
โ **Llamadas sรญncronas y asincrรณnicas**  
โ **Decisiones alternativas (ALT)**  
โ **Loops cuando aplica**  
โ **Integraciรณn con BD y APIs externas**  

**Todo documentado para entender exactamente QUร sucede, CUรNDO y CON QUIรN** ๐

---

**Documento Generado:** 20 de Octubre, 2025  
**Versiรณn:** 1.0  
**Estado:** โ COMPLETO
