@startuml
title Diagrama de Componentes - Sistema TarapacÃ¡ (Actualizado)
skinparam componentStyle rectangle

' ==================== CAPA DE PRESENTACIÃ“N ====================
package "Capa de PresentaciÃ³n" #LightBlue {
  [React SPA] as React
  
  package "PÃ¡ginas React" {
    [Projects] as PageProjects
    [Providers] as PageProviders
    [Cotizaciones] as PageCotizaciones
    [Presupuestos] as PagePresupuestos
    [BÃºsqueda] as PageBusqueda
    [Excel Online] as PageExcel
  }
  
  package "Servicios Frontend" {
    [ApiService] as FrontAPI
    [ProjectService] as FrontProject
    [ProviderService] as FrontProvider
    [CotizacionService] as FrontCotizacion
    [BackupService] as FrontBackup
  }
}

' ==================== CAPA DE APLICACIÃ“N ====================
package "Capa de AplicaciÃ³n (Node.js + Express)" #LightGreen {
  [API REST Express] as API
  [Morgan HTTP Logger] as Morgan
  [Error Handler] as ErrorHandler
  
  package "MÃ³dulos de Negocio" {
    [MÃ³dulo Auth] as ModAuth
    [MÃ³dulo GestiÃ³n Proyectos] as ModProjects
    [MÃ³dulo GestiÃ³n Proveedores] as ModProviders
    [MÃ³dulo BÃºsqueda Materiales] as ModSearch
    [MÃ³dulo Resumen Presupuesto] as ModBudget
    [MÃ³dulo Plantilla Excel] as ModExcel
    [MÃ³dulo Parser] as ModParser #Yellow
    [MÃ³dulo Cotizaciones] as ModCotizacion
    [MÃ³dulo Insumos] as ModInsumo
  }
  
  package "Sistema de Logs" #Yellow {
    [Winston Logger] as Logger
    [Log Files] as LogFiles
  }
  
  package "Sistema de CachÃ©" #Yellow {
    [Redis Client] as RedisClient
    [Cache Helper] as CacheHelper
  }
  
  package "Sistema de Colas" #Yellow {
    [BullMQ Manager] as QueueManager
    [PDF Worker] as PDFWorker
    [Excel Worker] as ExcelWorker
    [Provider Import Worker] as ProviderWorker
    [Search Worker] as SearchWorker
  }
}

' ==================== CAPA DE DATOS ====================
package "Capa de Datos" #LightYellow {
  database "PostgreSQL" as PG {
    [Users] as TUsers
    [Projects] as TProjects
    [Providers] as TProviders
    [Cotizaciones] as TCotizaciones
    [Insumos] as TInsumos
    [Ordenes Compra] as TOrdenesCompra
    [Actas ReuniÃ³n] as TActas
  }
}

' ==================== SERVICIOS COMPLEMENTARIOS ====================
package "Servicios Complementarios" #LightCoral {
  [BullMQ Queues] as BullMQ
  database "Redis Cache" as Redis
}

' ==================== FUENTES EXTERNAS ====================
package "Fuentes Externas" #LightGray {
  [SerpAPI] as SerpAPI
  [Sodimac API] as Sodimac
  [Easy API] as Easy
  [Construmart API] as Construmart
  [Archivos PDF] as PDF
  [Archivos Excel/CSV] as Excel
}

' ==================== CONEXIONES FRONTEND â†’ BACKEND ====================
React --> API : HTTP/JSON
PageProjects --> FrontProject
PageProviders --> FrontProvider
PageCotizaciones --> FrontCotizacion
PagePresupuestos --> FrontAPI
PageBusqueda --> FrontAPI
PageExcel --> FrontAPI

FrontAPI --> API
FrontProject --> API
FrontProvider --> API
FrontCotizacion --> API
FrontBackup --> API

' ==================== CONEXIONES API â†’ MIDDLEWARE ====================
API --> Morgan : HTTP Logging
API --> Logger : Application Logging
API --> ErrorHandler : Error Handling
API --> RedisClient : Cache Access

' ==================== CONEXIONES MÃ“DULOS â†’ BASE DE DATOS ====================
ModAuth --> TUsers
ModProjects --> TProjects
ModProviders --> TProviders
ModSearch --> PG
ModBudget --> TCotizaciones
ModBudget --> TInsumos
ModExcel --> PG
ModParser --> PG
ModCotizacion --> TCotizaciones
ModInsumo --> TInsumos

' ==================== CONEXIONES MÃ“DULOS â†’ CACHÃ‰ ====================
ModProviders ..> CacheHelper : usa cachÃ©
ModSearch ..> CacheHelper : usa cachÃ©
ModBudget ..> CacheHelper : usa cachÃ©
CacheHelper --> Redis

' ==================== CONEXIONES MÃ“DULOS â†’ COLAS ====================
ModParser --> QueueManager : encola jobs
QueueManager --> BullMQ
BullMQ --> Redis : backend

PDFWorker --> BullMQ : procesa jobs
ExcelWorker --> BullMQ : procesa jobs
ProviderWorker --> BullMQ : procesa jobs
SearchWorker --> BullMQ : procesa jobs

' ==================== CONEXIONES LOGS ====================
Logger --> LogFiles : escribe
Morgan --> Logger : envÃ­a logs HTTP
ModAuth ..> Logger
ModProjects ..> Logger
ModProviders ..> Logger
ModSearch ..> Logger
ModBudget ..> Logger
ModExcel ..> Logger
ModParser ..> Logger
ModCotizacion ..> Logger

' ==================== CONEXIONES EXTERNAS ====================
ModSearch --> SerpAPI : bÃºsquedas
ModProviders --> Sodimac : precios
ModProviders --> Easy : precios
ModProviders --> Construmart : precios
ModParser --> PDF : lee archivos
ModParser --> Excel : lee archivos
ModProviders --> Excel : importa CSV

' ==================== RELACIONES ENTRE MÃ“DULOS ====================
ModProjects -- ModProviders : opcional
ModProjects -- ModExcel : genera plantillas
ModBudget -- ModCotizacion : calcula
ModBudget -- ModInsumo : incluye

' ==================== NOTAS ====================
note right of ModParser
  ðŸ†• Nuevo mÃ³dulo
  Procesamiento asÃ­ncrono
  de archivos grandes
end note

note right of Logger
  ðŸ†• Sistema profesional
  - error.log
  - combined.log
  - http.log
end note

note right of Redis
  ðŸ†• CachÃ© en memoria
  - 10x mÃ¡s rÃ¡pido
  - TTL configurable
  - Backend de BullMQ
end note

note right of BullMQ
  ðŸ†• Sistema de colas
  - PDF processing
  - Excel processing
  - Provider import
  - Search processing
end note

@enduml
